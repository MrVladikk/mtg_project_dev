{% extends "mtg_app/base.html" %}

{% block title %}Создание колоды — MTG Коллекция{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-8">
    
    <div class="card bg-dark-panel border-warning border-opacity-50 shadow-lg">
      <div class="card-header bg-transparent border-secondary py-3">
        <h3 class="mb-0 fw-bold text-white text-center">
          <i class="bi bi-stack text-warning"></i> Создание колоды
        </h3>
      </div>
      
      <div class="card-body p-4">
        <form method="post">
          {% csrf_token %}
          
          <div class="mb-4">
            <h5 class="text-warning border-bottom border-secondary pb-2 mb-3">Информация</h5>
            
            {% for field in form %}
              <div class="mb-3">
                <label for="{{ field.id_for_label }}" class="form-label text-muted small text-uppercase fw-bold mb-1">
                  {{ field.label }}
                </label>
                <div class="input-group">
                  {{ field }}
                </div>
                {% if field.errors %}
                  <div class="text-danger small mt-1">{{ field.errors }}</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>

          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center border-bottom border-secondary pb-2 mb-3">
              <h5 class="text-warning mb-0">Карты</h5>
              <button type="button" id="add-card-btn" class="btn btn-sm btn-outline-light">
                <i class="bi bi-plus-lg"></i> Добавить карту
              </button>
            </div>

            {{ formset.management_form }}
            
            <div id="card-forms" class="d-flex flex-column gap-2">
              {% for form in formset %}
                <div class="card-form-row row g-2 align-items-start">
                  {% for field in form %}
                    {% if not field.is_hidden %}
                      <div class="col">
                        {{ field }}
                        {% if field.errors %}
                          <div class="text-danger small" style="font-size: 0.75rem;">{{ field.errors.0 }}</div>
                        {% endif %}
                      </div>
                    {% else %}
                      {{ field }}
                    {% endif %}
                  {% endfor %}
                  
                  {% if form.instance.pk %}
                    <div class="col-auto d-flex align-items-center pt-2">
                      <div class="form-check">
                        {{ form.DELETE }}
                        <label class="form-check-label text-danger small" for="{{ form.DELETE.id_for_label }}">Ud.</label>
                      </div>
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>

          <div class="d-flex justify-content-between align-items-center mt-5 pt-3 border-top border-secondary">
            <a href="{% url 'mtg_app:deck_list' %}" class="text-muted text-decoration-none transition-hover">
              <i class="bi bi-arrow-left"></i> Отмена
            </a>
            <button type="submit" class="btn btn-warning fw-bold px-5 py-2">
              Сохранить колоду
            </button>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>

<div id="empty-form" style="display: none;">
  <div class="card-form-row row g-2 align-items-start mt-2">
    {% for field in formset.empty_form %}
      {% if not field.is_hidden %}
        <div class="col">
          {{ field }}
        </div>
      {% else %}
        {{ field }}
      {% endif %}
    {% endfor %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const addBtn = document.getElementById('add-card-btn');
    const cardForms = document.getElementById('card-forms');
    const totalForms = document.getElementById('id_deck_cards-TOTAL_FORMS');
    
    // Берем HTML из скрытого шаблона
    const emptyFormHtml = document.getElementById('empty-form').innerHTML;

    addBtn.addEventListener('click', function() {
      const formIdx = totalForms.value;
      
      // Заменяем __prefix__ на текущий индекс
      const newFormHtml = emptyFormHtml.replace(/__prefix__/g, formIdx);
      
      // Добавляем в DOM
      const newDiv = document.createElement('div');
      newDiv.innerHTML = newFormHtml; // Обертка, чтобы вставить содержимое
      
      // Вставляем содержимое (первый ребенок, т.к. шаблон уже содержит row)
      cardForms.appendChild(newDiv.firstElementChild);
      
      totalForms.value = parseInt(formIdx) + 1;
    });
  });
</script>

<style>
  /* Стилизация всех инпутов и селектов внутри этой формы */
  input[type="text"], 
  input[type="number"], 
  textarea, 
  select {
    width: 100%;
    background-color: #000 !important;
    border: 1px solid var(--mtg-border);
    border-radius: 8px;
    padding: 10px;
    color: #fff;
    transition: border-color 0.2s;
  }

  input:focus, textarea:focus, select:focus {
    border-color: var(--mtg-gold);
    outline: none;
    box-shadow: 0 0 0 3px rgba(246, 194, 92, 0.15);
  }
  
  /* Для чекбокса удаления */
  input[type="checkbox"] {
    width: auto !important;
  }
</style>
{% endblock %}