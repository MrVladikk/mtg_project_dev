{% extends "mtg_app/base.html" %}

{% block title %}Редактор колоды{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

<style>
    /* 1. ФИКС "КРИВОГО ИНТЕРФЕЙСА" (Двойные поля) */
    select.select2-hidden-accessible {
        display: none !important;
        visibility: hidden !important;
        position: absolute !important; 
        width: 1px !important;
        height: 1px !important;
        overflow: hidden !important;
        padding: 0 !important;
        margin: -1px !important;
        border: 0 !important;
        clip: rect(0 0 0 0) !important;
    }

    /* 2. Стилизация инпутов (Темная тема) */
    input[type="text"], input[type="number"], textarea, .form-control,
    .select2-container--bootstrap-5 .select2-selection {
        background-color: #000 !important;
        border: 1px solid #444 !important;
        color: #fff !important;
        border-radius: 4px;
        padding: 8px;
        width: 100% !important; /* Гарантируем ширину */
    }
    input:focus, textarea:focus {
        border-color: #f6c25c !important;
        outline: none;
    }

    /* 3. Стили Select2 (Выпадающий список) */
    .select2-dropdown { background-color: #17171c !important; border-color: #444 !important; }
    .select2-results__option { color: #ccc !important; }
    .select2-results__option--highlighted { background-color: #f6c25c !important; color: #000 !important; }
    .select2-search__field { background-color: #222 !important; color: #fff !important; }
    
    /* 4. Стиль для подсветки дубликата */
    .row-highlight {
        animation: highlight 1s ease;
    }
    @keyframes highlight {
        from { background-color: #f6c25c; }
        to { background-color: #303035; } /* Возвращаем к .bg-dark */
    }
</style>
{% endblock %}


{% block content %}
<div class="row justify-content-center">
  
  <div class="col-lg-8">
    <div class="card bg-dark-panel border-warning border-opacity-50 shadow-lg mb-5">
      <div class="card-header bg-transparent border-secondary py-3">
        <h3 class="mb-0 fw-bold text-white text-center">
          <i class="bi bi-stack text-warning"></i> Редактор колоды
        </h3>
      </div>
      
      <div class="card-body p-4">
        <form method="post" id="deck-form">
          {% csrf_token %}
          
          <div class="mb-4 p-3 rounded bg-black bg-opacity-25 border border-secondary">
            <h5 class="text-warning mb-3">Настройки</h5>
            {% for field in form %}
              <div class="mb-3">
                <label class="form-label text-muted small text-uppercase fw-bold">{{ field.label }}</label>
                {{ field }}
                {% if field.errors %}<div class="text-danger small mt-1">{{ field.errors }}</div>{% endif %}
              </div>
            {% endfor %}
          </div>

          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center border-bottom border-secondary pb-2 mb-3">
              <h5 class="text-white mb-0">Список карт</h5>
              <button type="button" id="add-card-btn" class="btn btn-sm btn-warning fw-bold">
                <i class="bi bi-plus-lg"></i> Добавить карту
              </button>
            </div>

            <div id="formset-management">
                {{ formset.management_form }}
            </div>
            
            <div id="formset-container" class="d-flex flex-column gap-2">
              {% for form in formset %}
                <div class="card-row row g-2 align-items-end bg-dark p-2 rounded border border-secondary">
                  {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                  <div class="col">
                    {{ form.card }}
                    {% if form.card.errors %}<div class="text-danger small">{{ form.card.errors }}</div>{% endif %}
                  </div>
                  <div class="col-3 col-md-2">
                    <label class="small text-muted d-block mb-1">Кол-во</label>
                    {{ form.quantity }}
                  </div>
                  {% if form.instance.pk %}
                    <div class="col-auto pb-1">
                      <div class="form-check">{{ form.DELETE }}<label class="text-danger small"><i class="bi bi-trash"></i></label></div>
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>

          <div class="d-flex justify-content-between align-items-center mt-4">
            <a href="{% url 'mtg_app:deck_list' %}" class="btn btn-outline-light">Отмена</a>
            <button type="submit" class="btn btn-warning fw-bold px-5">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-lg-4 d-none d-lg-block">
    <div class="sticky-top" style="top: 100px;">
      <div class="card bg-black border-warning border-opacity-50">
        <div class="card-body text-center p-3">
          <h6 class="text-muted text-uppercase mb-3">Предпросмотр</h6>
          <div class="mtg-card-img-wrapper rounded border border-secondary" style="position: relative; min-height: 300px;">
            <img src="" id="card-preview-img" style="display: none; width: 100%; height: 100%; object-fit: contain;">
            <div id="card-preview-placeholder" class="d-flex align-items-center justify-content-center text-muted h-100 w-100" style="position: absolute; top: 0;">
              <div class="p-4"><i class="bi bi-card-image display-4 mb-2"></i><br>Выберите карту</div>
            </div>
          </div>
          <p id="preview-name" class="mt-2 text-white fw-bold mb-0">&nbsp;</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/template" id="empty-form-template">
  <div class="card-row row g-2 align-items-end bg-dark p-2 rounded border border-secondary mt-2">
      {% for hidden in formset.empty_form.hidden_fields %}
          {{ hidden }}
      {% endfor %}
      
      <div class="col">
          {{ formset.empty_form.card }}
      </div>
      <div class="col-3 col-md-2">
          <label class="small text-muted d-block mb-1">Кол-во</label>
          {{ formset.empty_form.quantity }}
      </div>
      <div class="col-auto pb-1">
         <button type="button" class="btn btn-sm btn-outline-danger remove-row-btn" title="Удалить строку"><i class="bi bi-x-lg"></i></button>
      </div>
  </div>
</script>

{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    console.log("--- Deck Editor: Duplicate Handler (v2) ---");

    // --- 1. Настройка Select2 ---
    function initSelect2(element) {
        $(element).select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: 'Поиск карты...',
            allowClear: true
        });

        // --- УМНЫЙ ОБРАБОТЧИК ВЫБОРА (с дедупликацией) ---
        $(element).on('select2:select', function (e) {
            var cardId = e.params.data.id;
            var cardName = e.params.data.text;
            loadPreview(cardId, cardName);

            var currentRow = $(this).closest('.card-row');
            
            var existingRow = null;
            $('#formset-container .card-row').each(function() {
                if ($(this).is(currentRow)) return; 
                
                // Ищем select, у которого ID заканчивается на '-card'
                var select = $(this).find('select[id$="-card"]'); 
                if (select.val() == cardId) {
                    existingRow = $(this);
                    return false; 
                }
            });

            // Если нашли дубликат
            if (existingRow) {
                // 1. Увеличиваем количество в старой строке
                var qtyInput = existingRow.find('input[id$="-quantity"]');
                qtyInput.val(parseInt(qtyInput.val() || 0) + 1);
                
                // 2. Подсвечиваем старую строку
                existingRow.addClass('row-highlight');
                setTimeout(function() { existingRow.removeClass('row-highlight'); }, 1000);

                // 3. Удаляем новую (текущую) строку
                currentRow.remove();
            }
        });
    }

    // --- 2. Превью карты ---
    function loadPreview(cardId, cardName) {
        if (!cardId) return;
        $.ajax({
            url: "{% url 'mtg_app:get_card_image' %}",
            data: { 'id': cardId },
            success: function(data) {
                if (data.url) {
                    $('#card-preview-placeholder').hide();
                    $('#card-preview-img').attr('src', data.url).show();
                    $('#preview-name').text(cardName);
                } else {
                    $('#card-preview-img').hide();
                    $('#card-preview-placeholder').show();
                    $('#preview-name').text(cardName + " (Нет фото)");
                }
            }
        });
    }

    // --- 3. Инициализация (старт) ---
    // Применяем Select2 ко всем select'ам с именем, содержащим 'card'
    $('#formset-container select[name*="card"]').each(function() {
        initSelect2(this);
    });

    // --- 4. Кнопка "Добавить карту" ---
    $('#add-card-btn').click(function(e) {
        e.preventDefault();
        
        // Жестко ищем по ID (prefix='deck_cards')
        var totalFormsInput = $('#id_deck_cards-TOTAL_FORMS');
        if (totalFormsInput.length === 0) {
            console.error("CRITICAL: Не найдено поле #id_deck_cards-TOTAL_FORMS!");
            return;
        }

        var formIdx = parseInt(totalFormsInput.val());
        
        // --- ИСПРАВЛЕНИЕ: Берем HTML из шаблона
        var template = $('#empty-form-template').html();
        var newRowHtml = template.replace(/__prefix__/g, formIdx);
        
        $('#formset-container').append(newRowHtml);
        totalFormsInput.val(formIdx + 1);

        // Инициализируем Select2 на новой строке
        var newRow = $('#formset-container .card-row').last();
        var newSelect = newRow.find('select');
        initSelect2(newSelect);
        newSelect.select2('open'); // Сразу открываем
    });

    // --- 5. Удаление ---
    $(document).on('click', '.remove-row-btn', function() {
        $(this).closest('.card-row').remove();
    });

});
</script>
{% endblock %}