{% extends "mtg_app/base.html" %}

{% block title %}{{ thread.title }} — Форум{% endblock %}

{% block content %}
<div class="mb-4">
  <a href="{% url 'forum:thread_list' %}" class="text-decoration-none text-muted hover-warning">
    <i class="bi bi-arrow-left"></i> Назад к списку тем
  </a>
</div>

<div class="mb-4 border-bottom border-secondary pb-3 d-flex justify-content-between align-items-start">
  <h1 class="display-6 fw-bold text-white mb-0">{{ thread.title }}</h1>
  
  {% if user == thread.author or user.is_staff %}
    <a href="{% url 'forum:thread_delete' pk=thread.id %}" class="btn btn-sm btn-outline-danger ms-3">
      <i class="bi bi-trash"></i> Удалить тему
    </a>
  {% endif %}
</div>

<div class="card bg-dark-panel mb-4 border-warning border-top-0 border-end-0 border-bottom-0 border-4">
  <div class="card-body p-4">
    <div class="d-flex gap-3">
      <div class="d-none d-sm-block text-center" style="width: 80px;">
        <div class="rounded-circle bg-warning d-flex align-items-center justify-content-center fw-bold text-dark fs-4 mx-auto mb-2" style="width: 50px; height: 50px;">
          {{ thread.author.username|first|upper }}
        </div>
        <small class="d-block text-warning text-truncate fw-bold">{{ thread.author.username }}</small>
      </div>

      <div class="flex-grow-1">
        <div class="d-flex justify-content-between mb-3">
          <div class="d-sm-none d-flex align-items-center gap-2 mb-2">
             <span class="badge bg-warning text-dark">{{ thread.author.username }}</span>
          </div>
          <small class="text-muted ms-auto"><i class="bi bi-calendar3"></i> {{ thread.created_at|date:"d E Y, H:i" }}</small>
        </div>
        
        <div class="text-white fs-5" style="white-space: pre-line;">{{ thread.content }}</div>
      </div>
    </div>
  </div>
</div>

{% if posts %}
  <h5 class="text-muted mb-3 ps-2 border-start border-2 border-secondary">Ответы ({{ posts.count }})</h5>
{% endif %}

<div class="d-flex flex-column gap-3 mb-5">
  {% for post in posts %}
    <div class="card bg-dark-panel border-0 shadow-sm">
      <div class="card-body p-3">
        <div class="d-flex gap-3">
          <div class="text-center" style="width: 60px;">
            <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center fw-bold text-white mx-auto" style="width: 40px; height: 40px;">
              {{ post.author.username|first|upper }}
            </div>
          </div>

          <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="fw-bold text-light">{{ post.author.username }}</span>
              <div class="d-flex align-items-center gap-2">
                <small class="text-muted" style="font-size: 0.8rem;">{{ post.created_at|date:"d.m.Y H:i" }}</small>
                {% if user == post.author or user.is_staff %}
                  <a href="{% url 'forum:post_delete' pk=post.id %}" class="text-danger opacity-50 hover-opacity-100" title="Удалить">
                    <i class="bi bi-x-lg"></i>
                  </a>
                {% endif %}
              </div>
            </div>
            <p class="mb-0 text-white-50">{{ post.content|linebreaksbr }}</p>
          </div>
        </div>
      </div>
    </div>
  {% empty %}
    <div class="text-center text-muted py-4 fst-italic">
      Пока нет ответов.
    </div>
  {% endfor %}
</div>

{% if user.is_authenticated %}
  <div class="card bg-dark-panel border-secondary mt-4">
    <div class="card-header bg-transparent border-secondary text-white fw-bold py-3">
      <i class="bi bi-reply-fill text-warning"></i> Написать ответ
    </div>
    <div class="card-body p-4">
      <form method="post">
        {% csrf_token %}
        <div class="mb-3">
          <textarea name="content" class="form-control bg-black text-white border-secondary" rows="4" placeholder="Введите ваш ответ..." required></textarea>
        </div>
        <div class="d-flex justify-content-end">
          <button type="submit" class="btn btn-warning fw-bold px-4">Отправить</button>
        </div>
      </form>
    </div>
  </div>
{% else %}
  <div class="alert alert-dark border-secondary text-center my-5">
    <a href="{% url 'mtg_app:login' %}" class="fw-bold text-warning">Войдите</a>, чтобы оставить ответ.
  </div>
{% endif %}

<style>
  .hover-opacity-100:hover { opacity: 1 !important; }
  .hover-warning:hover { color: var(--mtg-gold) !important; }
</style>
{% endblock %}